#!/bin/bash

set -e

INSTANCE="${1:?缺少实例参数}"
CONFIG_FILE="/etc/wangyunchuan/token_$INSTANCE"

# 记录启动日志
logger -t "wangyunchuan-wrapper" "启动实例: $INSTANCE, 当前用户: $(whoami)"

# 检查当前用户
CURRENT_USER=$(whoami)
if [[ "$CURRENT_USER" != "wangyunchuan" ]]; then
    echo "错误: 脚本应以 wangyunchuan 用户运行" >&2
    logger -t "wangyunchuan-wrapper" "错误: 需要以 wangyunchuan 用户运行"

    # 如果是root，切换到正确用户
    if [[ $EUID -eq 0 ]]; then
        exec sudo -u wangyunchuan "$0" "$@"
    else
        exit 1
    fi
fi

# 检查配置文件存在性和权限
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "错误: 配置文件不存在: $CONFIG_FILE" >&2
    logger -t "wangyunchuan-wrapper" "错误: 配置文件不存在"
    exit 1
fi

# 检查文件所有权
FILE_OWNER=$(stat -c "%U" "$CONFIG_FILE")
if [[ "$FILE_OWNER" != "wangyunchuan" ]]; then
    echo "错误: 配置文件所有者不正确: $FILE_OWNER (应为 wangyunchuan)" >&2
    logger -t "wangyunchuan-wrapper" "错误: 配置文件所有者不正确"
    exit 1
fi

# 检查文件权限
FILE_PERMS=$(stat -c "%a" "$CONFIG_FILE")
if [[ "$FILE_PERMS" != "600" ]]; then
    echo "错误: 配置文件权限不正确: $FILE_PERMS (应为 600)" >&2
    logger -t "wangyunchuan-wrapper" "错误: 配置文件权限不正确"
    exit 1
fi

# 加载配置
source "$CONFIG_FILE"

# 检查必要变量
if [[ -z "$WYC_TOKEN" ]]; then
    echo "错误: 配置文件中未找到令牌" >&2
    exit 1
fi

# 获取日志前缀
if [[ -n "${WYCLOG_PREFIX:-}" ]]; then
    LOG_PREFIX="$WYCLOG_PREFIX"
else
    LOG_PREFIX="${WYC_TOKEN:0:8}"
fi

# 创建日志目录（仅使用令牌前缀，不创建符号链接）
LOG_DIR="/var/log/wangyunchuan/$LOG_PREFIX"
mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"

# 记录启动信息
echo "$(date): 启动网云穿实例 $INSTANCE, 令牌前缀: $LOG_PREFIX" >> "$LOG_DIR/output.log"

# 执行主程序
exec /usr/bin/wyc -token="$WYC_TOKEN" -run >> "$LOG_DIR/output.log" 2>> "$LOG_DIR/error.log"
