#!/bin/bash

set -e

INSTANCE="$1"
CONFIG_FILE="/etc/wangyunchuan/token_$INSTANCE"

# 检查配置文件
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "错误: 配置文件不存在: $CONFIG_FILE" >&2
    exit 1
fi

# 加载配置
source "$CONFIG_FILE"

# 检查令牌
if [[ -z "$WYC_TOKEN" ]]; then
    echo "错误: 配置文件中未找到令牌" >&2
    exit 1
fi

# 获取日志前缀（优先使用 WYCLOG_PREFIX，回退到令牌前8位）
if [[ -n "$WYCLOG_PREFIX" ]]; then
    LOG_PREFIX="$WYCLOG_PREFIX"
else
    LOG_PREFIX="${WYC_TOKEN:0:8}"
fi

# 创建日志目录
LOG_DIR="/var/log/wangyunchuan/$LOG_PREFIX"
mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"

# 创建符号链接
INSTANCE_LINK="/var/log/wangyunchuan/$INSTANCE"
rm -f "$INSTANCE_LINK" 2>/dev/null || true
ln -sfn "$LOG_DIR" "$INSTANCE_LINK"

# 执行主程序，重定向输出
exec /usr/bin/wyc -token="$WYC_TOKEN" -run >> "$LOG_DIR/output.log" 2>> "$LOG_DIR/error.log"
