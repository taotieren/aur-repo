#!/bin/bash

set -e

show_usage() {
    cat <<'EOF'
ç½‘äº‘ç©¿æœåŠ¡ç®¡ç†å·¥å…·
ç”¨æ³•: wycctl <å‘½ä»¤> [å‚æ•°]

å‘½ä»¤:
  add <å®ä¾‹å> <token>     æ·»åŠ æ–°å®ä¾‹
  remove <å®ä¾‹å>          åˆ é™¤å®ä¾‹
  start <å®ä¾‹å>           å¯åŠ¨å®ä¾‹
  stop <å®ä¾‹å>            åœæ­¢å®ä¾‹
  restart <å®ä¾‹å>         é‡å¯å®ä¾‹
  status <å®ä¾‹å>          æŸ¥çœ‹å®ä¾‹çŠ¶æ€
  list                    åˆ—å‡ºæ‰€æœ‰å®ä¾‹
  logpath <å®ä¾‹å>        æŸ¥çœ‹å®ä¾‹æ—¥å¿—è·¯å¾„
  fix-perms               ä¿®å¤æƒé™é—®é¢˜
  logs <å®ä¾‹å>           æŸ¥çœ‹å®ä¾‹æ—¥å¿—

ç¤ºä¾‹:
  wycctl add web token12345678
  wycctl start web
  wycctl logs web
EOF
}

# æ£€æŸ¥rootæƒé™
check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "é”™è¯¯: æ­¤å‘½ä»¤éœ€è¦rootæƒé™" >&2
        exit 1
    fi
}

# ä¿®å¤æƒé™
fix_permissions() {
    check_root

    echo "æ­£åœ¨ä¿®å¤æƒé™..."

    # åˆ›å»ºç”¨æˆ·
    if ! id wangyunchuan &>/dev/null; then
        useradd -r -s /bin/false -d /nonexistent -M wangyunchuan
        echo "åˆ›å»ºç”¨æˆ·: wangyunchuan"
    fi

    # åˆ›å»ºç›®å½•
    mkdir -p /etc/wangyunchuan
    mkdir -p /var/log/wangyunchuan

    # è®¾ç½®ç›®å½•æƒé™
    chown wangyunchuan:wangyunchuan /etc/wangyunchuan
    chmod 750 /etc/wangyunchuan

    chown wangyunchuan:wangyunchuan /var/log/wangyunchuan
    chmod 755 /var/log/wangyunchuan

    echo "âœ… æƒé™ä¿®å¤å®Œæˆ"
}

# æ·»åŠ å®ä¾‹
add_instance() {
    check_root

    local instance="$1"
    local token="$2"

    if [[ -z "$instance" || -z "$token" ]]; then
        echo "é”™è¯¯: éœ€è¦æä¾›å®ä¾‹åå’Œ token" >&2
        exit 1
    fi

    # éªŒè¯tokenæ ¼å¼
    if [[ ! "$token" =~ ^[a-zA-Z0-9]{16}$ ]]; then
        echo "é”™è¯¯: Token å¿…é¡»ä¸º 16 ä½å­—æ¯æ•°å­—ç»„åˆ" >&2
        exit 1
    fi

    local log_prefix="${token:0:8}"
    local token_file="/etc/wangyunchuan/${instance}_token"

    # ç¡®ä¿åŸºç¡€ç¯å¢ƒ
    fix_permissions

    # åˆ›å»ºtokenæ–‡ä»¶
    cat >"$token_file" <<EOF
WYC_TOKEN=${token}
WYCLOG_PREFIX=${log_prefix}
INSTANCE=${instance}
EOF

    chmod 640 "$token_file"
    chown wangyunchuan:wangyunchuan "$token_file"

    # åˆ›å»ºæ—¥å¿—ç›®å½•
    local log_dir="/var/log/wangyunchuan/$log_prefix"
    mkdir -p "$log_dir"
    chown wangyunchuan:wangyunchuan "$log_dir"
    chmod 755 "$log_dir"

    echo "âœ… å®ä¾‹æ·»åŠ æˆåŠŸ: $instance"
    echo "ğŸ“ é…ç½®æ–‡ä»¶: $token_file"
    echo "ğŸ“ æ—¥å¿—ç›®å½•: $log_dir"

    systemctl daemon-reload
}

# åˆ é™¤å®ä¾‹
remove_instance() {
    check_root

    local instance="$1"

    if [[ -z "$instance" ]]; then
        echo "é”™è¯¯: éœ€è¦æä¾›å®ä¾‹å" >&2
        exit 1
    fi

    local token_file="/etc/wangyunchuan/${instance}_token"

    if [[ ! -f "$token_file" ]]; then
        echo "é”™è¯¯: å®ä¾‹ä¸å­˜åœ¨: $instance" >&2
        exit 1
    fi

    # åœæ­¢æœåŠ¡
    systemctl stop "wangyunchuan@$instance" 2>/dev/null || true
    systemctl disable "wangyunchuan@$instance" 2>/dev/null || true

    # è·å–æ—¥å¿—ç›®å½•
    source "$token_file" 2>/dev/null || true
    local log_dir="/var/log/wangyunchuan/${WYCLOG_PREFIX}"

    # åˆ é™¤æ–‡ä»¶
    rm -f "$token_file"

    # è¯¢é—®æ˜¯å¦åˆ é™¤æ—¥å¿—ç›®å½•
    if [[ -d "$log_dir" ]]; then
        read -p "æ˜¯å¦åˆ é™¤æ—¥å¿—ç›®å½• $log_dir? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            rm -rf "$log_dir"
            echo "å·²åˆ é™¤æ—¥å¿—ç›®å½•"
        fi
    fi

    systemctl daemon-reload
    echo "âœ… å®ä¾‹åˆ é™¤æˆåŠŸ: $instance"
}

# åˆ—å‡ºå®ä¾‹
list_instances() {
    echo "å·²é…ç½®çš„å®ä¾‹:"
    echo "=============="

    for token_file in /etc/wangyunchuan/*_token; do
        if [[ -f "$token_file" ]]; then
            local instance=$(basename "$token_file" "_token")
            source "$token_file" 2>/dev/null || continue

            local status=$(systemctl is-active "wangyunchuan@$instance" 2>/dev/null || echo "æœªè¿è¡Œ")
            local enabled=$(systemctl is-enabled "wangyunchuan@$instance" 2>/dev/null || echo "-")

            printf "%-12s %-8s... %-10s %s\n" \
                "$instance" \
                "${WYC_TOKEN:0:8}" \
                "$status" \
                "$([ "$enabled" = "enabled" ] && echo "âœ“" || echo "")"
        fi
    done
}

# æŸ¥çœ‹æ—¥å¿—è·¯å¾„
show_log_path() {
    local instance="$1"
    local token_file="/etc/wangyunchuan/${instance}_token"

    if [[ ! -f "$token_file" ]]; then
        echo "é”™è¯¯: å®ä¾‹ä¸å­˜åœ¨: $instance" >&2
        exit 1
    fi

    source "$token_file"
    echo "å®ä¾‹: $instance"
    echo "æ—¥å¿—å‰ç¼€: $WYCLOG_PREFIX"
    echo "æ—¥å¿—ç›®å½•: /var/log/wangyunchuan/$WYCLOG_PREFIX"

    if [[ -d "/var/log/wangyunchuan/$WYCLOG_PREFIX" ]]; then
        echo "æ—¥å¿—æ–‡ä»¶:"
        ls -la "/var/log/wangyunchuan/$WYCLOG_PREFIX/" 2>/dev/null || echo "ç›®å½•ä¸ºç©º"
    fi
}

# æŸ¥çœ‹æ—¥å¿—
show_logs() {
    local instance="$1"
    local token_file="/etc/wangyunchuan/${instance}_token"

    if [[ ! -f "$token_file" ]]; then
        echo "é”™è¯¯: å®ä¾‹ä¸å­˜åœ¨: $instance" >&2
        exit 1
    fi

    source "$token_file"
    local log_dir="/var/log/wangyunchuan/$WYCLOG_PREFIX"

    if [[ ! -d "$log_dir" ]]; then
        echo "æ—¥å¿—ç›®å½•ä¸å­˜åœ¨: $log_dir" >&2
        exit 1
    fi

    # æŸ¥æ‰¾æœ€æ–°çš„æ—¥å¿—æ–‡ä»¶
    local latest_log=$(find "$log_dir" -type f -name "*.log" | sort -r | head -1)

    if [[ -n "$latest_log" && -f "$latest_log" ]]; then
        echo "æ­£åœ¨æŸ¥çœ‹æ—¥å¿—: $latest_log"
        echo "========================"
        tail -f "$latest_log"
    else
        echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
        # æŸ¥çœ‹systemdæ—¥å¿—
        journalctl -u "wangyunchuan@$instance" -f
    fi
}

# ä¸»é€»è¾‘
case "${1:-}" in
add)
    add_instance "$2" "$3"
    ;;
remove | del)
    remove_instance "$2"
    ;;
start)
    local instance="$2"
    if [[ -z "$instance" ]]; then
        echo "é”™è¯¯: éœ€è¦æä¾›å®ä¾‹å" >&2
        exit 1
    fi
    
    # å¯åŠ¨å‰æ£€æŸ¥å’Œå‡†å¤‡ç¯å¢ƒ
    local token_file="/etc/wangyunchuan/${instance}_token"
    if [[ -f "$token_file" ]]; then
        source "$token_file"
        local log_dir="/var/log/wangyunchuan/$WYCLOG_PREFIX"
        if [[ ! -d "$log_dir" ]]; then
            echo "å‡†å¤‡æ—¥å¿—ç›®å½•: $log_dir"
            mkdir -p "$log_dir"
            chown wangyunchuan:wangyunchuan "$log_dir"
            chmod 755 "$log_dir"
        fi
    fi
    
    systemctl start "wangyunchuan@$instance"
    systemctl status "wangyunchuan@$instance" --no-pager
    ;;
stop)
    systemctl stop "wangyunchuan@$2"
    ;;
restart)
    systemctl restart "wangyunchuan@$2"
    systemctl status "wangyunchuan@$2" --no-pager
    ;;
status)
    systemctl status "wangyunchuan@$2" --no-pager
    ;;
list)
    list_instances
    ;;
logpath)
    show_log_path "$2"
    ;;
logs)
    show_logs "$2"
    ;;
fix-perms)
    fix_permissions
    ;;
"" | help | --help | -h)
    show_usage
    ;;
*)
    echo "é”™è¯¯: æœªçŸ¥å‘½ä»¤ '$1'" >&2
    echo "ä½¿ç”¨ 'wycctl help' æŸ¥çœ‹å¸®åŠ©" >&2
    exit 1
    ;;
esac
