#!/bin/bash

set -euo pipefail

main() {
    local instance="${1:?å®žä¾‹åç§°æœªæŒ‡å®š}"
    local token="${2:-}"
    local config_file="/etc/wangyunchuan/token_$instance"
    local lock_file="/etc/wangyunchuan/.lock_$instance"
    
    # åˆ›å»ºç›®å½•
    mkdir -p "/etc/wangyunchuan"
    
    # æ–‡ä»¶é”
    exec 9>"$lock_file"
    flock -n 9 || { echo "é”™è¯¯: é…ç½®æ­£åœ¨è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨"; exit 1; }
    
    # èŽ·å–ä»¤ç‰Œ
    if [[ -z "$token" ]]; then
        read -rsp "è¯·è¾“å…¥å®žä¾‹ '$instance' çš„ä»¤ç‰Œ: " token
        echo
    fi
    
    # éªŒè¯ä»¤ç‰Œ
    [[ "$token" =~ ^[a-zA-Z0-9]{16}$ ]] || {
        echo "é”™è¯¯: ä»¤ç‰Œå¿…é¡»ä¸º16ä½å­—æ¯æ•°å­—ç»„åˆ"
        exit 1
    }
    
    # è®¡ç®—ä»¤ç‰Œå‰ç¼€
    token_prefix="${token:0:8}"
    
    # å†™å…¥é…ç½®
    cat > "$config_file" <<EOF
WYC_TOKEN=$token
WYCLOG_PREFIX=$token_prefix
INSTANCE=$instance
EOF
    
    chmod 600 "$config_file"
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    log_dir="/var/log/wangyunchuan/$token_prefix"
    mkdir -p "$log_dir"
    chmod 755 "$log_dir"
    
    echo "âœ… é…ç½®å·²ä¿å­˜: $config_file"
    echo "ðŸ“‹ å®žä¾‹: $instance"
    echo "ðŸ” ä»¤ç‰Œå‰ç¼€: $token_prefix"
    echo "ðŸ“ æ—¥å¿—ç›®å½•: $log_dir"
    
    # æ¸…ç†é”æ–‡ä»¶
    flock -u 9
    rm -f "$lock_file"
}

# å‚æ•°æ£€æŸ¥
if [[ $# -lt 1 ]]; then
    echo "ç”¨æ³•: $0 <å®žä¾‹åç§°> [ä»¤ç‰Œ]"
    echo "ç¤ºä¾‹: $0 ssh"
    echo "       $0 web gS2oWgd7b4R1GPi4"
    exit 1
fi

main "$@"