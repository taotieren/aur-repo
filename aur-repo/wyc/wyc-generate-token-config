#!/bin/bash

set -euo pipefail

main() {
    local instance="${1:?å®ä¾‹åç§°æœªæŒ‡å®š}"
    local token="${2:-}"
    local config_file="/etc/wangyunchuan/token_$instance"
    local lock_file="/etc/wangyunchuan/.lock_$instance"
    
    # åˆ›å»ºç›®å½•
    mkdir -p "/etc/wangyunchuan"
    
    # æ–‡ä»¶é”
    exec 9>"$lock_file"
    flock -n 9 || { echo "é”™è¯¯: é…ç½®æ­£åœ¨è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨"; exit 1; }
    
    # è·å–ä»¤ç‰Œ
    if [[ -z "$token" ]]; then
        read -rsp "è¯·è¾“å…¥å®ä¾‹ '$instance' çš„ä»¤ç‰Œ: " token
        echo
    fi
    
    # éªŒè¯ä»¤ç‰Œ
    [[ "$token" =~ ^[a-zA-Z0-9]{16}$ ]] || {
        echo "é”™è¯¯: ä»¤ç‰Œå¿…é¡»ä¸º16ä½å­—æ¯æ•°å­—ç»„åˆ"
        exit 1
    }
    
    # å†™å…¥é…ç½®
    echo "WYC_TOKEN=$token" > "$config_file"
    chmod 600 "$config_file"
    
    echo "âœ… é…ç½®å·²ä¿å­˜: $config_file"
    echo "ğŸ“‹ å®ä¾‹: $instance"
    echo "ğŸ” ä»¤ç‰Œ: ${token:0:8}..."
}

# å‚æ•°æ£€æŸ¥
if [[ $# -lt 1 ]]; then
    echo "ç”¨æ³•: $0 <å®ä¾‹åç§°> [ä»¤ç‰Œ]"
    echo "ç¤ºä¾‹: $0 ssh"
    echo "       $0 web gS2oWgd7b4R1GPi4"
    exit 1
fi

main "$@"