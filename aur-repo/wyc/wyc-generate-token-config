#!/bin/bash

set -euo pipefail

main() {
    local instance="${1:?å®žä¾‹åç§°æœªæŒ‡å®š}"
    local token="${2:-}"
    local config_file="/etc/wangyunchuan/token_$instance"
    local lock_file="/etc/wangyunchuan/.lock_$instance"

    # æ£€æŸ¥æ˜¯å¦ä»¥rootè¿è¡Œ
    if [[ $EUID -ne 0 ]]; then
        echo "é”™è¯¯: æ­¤è„šæœ¬éœ€è¦rootæƒé™" >&2
        echo "è¯·ä½¿ç”¨: sudo $0 $instance $token" >&2
        exit 1
    fi

    # åˆ›å»ºç›®å½•
    mkdir -p "/etc/wangyunchuan"

    # è®¾ç½®ç›®å½•æƒé™
    chown wangyunchuan:wangyunchuan "/etc/wangyunchuan"
    chmod 750 "/etc/wangyunchuan"

    # æ–‡ä»¶é”
    exec 9>"$lock_file"
    flock -n 9 || {
        echo "é”™è¯¯: é…ç½®æ­£åœ¨è¢«å…¶ä»–è¿›ç¨‹ä½¿ç”¨"
        exit 1
    }

    # èŽ·å–ä»¤ç‰Œ
    if [[ -z "$token" ]]; then
        read -rsp "è¯·è¾“å…¥å®žä¾‹ '$instance' çš„ä»¤ç‰Œ: " token
        echo
    fi

    # éªŒè¯ä»¤ç‰Œ
    [[ "$token" =~ ^[a-zA-Z0-9]{16}$ ]] || {
        echo "é”™è¯¯: ä»¤ç‰Œå¿…é¡»ä¸º16ä½å­—æ¯æ•°å­—ç»„åˆ"
        exit 1
    }

    # è®¡ç®—ä»¤ç‰Œå‰ç¼€
    token_prefix="${token:0:8}"

    # å†™å…¥é…ç½®
    cat >"$config_file" <<EOF
WYC_TOKEN=$token
WYCLOG_PREFIX=$token_prefix
INSTANCE=$instance
EOF

    # å…³é”®ä¿®å¤ï¼šè®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æ‰€æœ‰æƒå’Œæƒé™
    chown wangyunchuan:wangyunchuan "$config_file"
    chmod 600 "$config_file"

    # åˆ›å»ºæ—¥å¿—ç›®å½•å¹¶è®¾ç½®æ­£ç¡®æƒé™
    log_dir="/var/log/wangyunchuan/$token_prefix"
    mkdir -p "$log_dir"
    chown wangyunchuan:wangyunchuan "$log_dir"
    chmod 755 "$log_dir"

    echo "âœ… é…ç½®å·²ä¿å­˜: $config_file"
    echo "ðŸ“‹ å®žä¾‹: $instance"
    echo "ðŸ” ä»¤ç‰Œå‰ç¼€: $token_prefix"
    echo "ðŸ“ æ—¥å¿—ç›®å½•: $log_dir"
    echo "ðŸ‘¤ æ–‡ä»¶æ‰€æœ‰è€…: $(stat -c "%U:%G" "$config_file")"
    echo "ðŸ”’ æ–‡ä»¶æƒé™: $(stat -c "%a" "$config_file")"

    # éªŒè¯æƒé™è®¾ç½®
    if [[ $(stat -c "%U" "$config_file") == "wangyunchuan" ]] &&
        [[ $(stat -c "%a" "$config_file") == "600" ]]; then
        echo "âœ… æƒé™éªŒè¯é€šè¿‡"
    else
        echo "âŒ æƒé™è®¾ç½®å¼‚å¸¸"
        exit 1
    fi

    # æ¸…ç†é”æ–‡ä»¶
    flock -u 9
    rm -f "$lock_file"
}

# å‚æ•°æ£€æŸ¥
if [[ $$# -lt 1 ]]; then
    echo "ç”¨æ³•: sudo $0 <å®žä¾‹åç§°> [ä»¤ç‰Œ]"
    echo "ç¤ºä¾‹: sudo $0 ssh"
    echo "       sudo $0 web token1234567890"
    exit 1
fi

main "$@"
